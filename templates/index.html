<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI 資產助手</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ai-blue: #007bff; --ai-glow: rgba(0, 123, 255, 0.2); }
        body { background-color: #0b0e14; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .card { background: #161b22; border: 1px solid #30363d; border-radius: 15px; color: white; margin-bottom: 20px; }
        .ai-chat-bubble { background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); border-radius: 20px 20px 20px 0; padding: 20px; box-shadow: 0 0 20px var(--ai-glow); border: 1px solid #3b82f6; }
        .stat-card { border-top: 4px solid var(--ai-blue); }
        .form-control, .form-select { background: #0d1117; border: 1px solid #30363d; color: white; }
        .form-control:focus { background: #0d1117; color: white; border-color: var(--ai-blue); box-shadow: 0 0 8px var(--ai-glow); }
        .btn-ai { background: var(--ai-blue); color: white; border-radius: 10px; font-weight: bold; transition: 0.3s; }
        .btn-ai:hover { background: #0056b3; transform: scale(1.02); }
        .nav-tabs .nav-link { color: #8b949e; border: none; }
        .nav-tabs .nav-link.active { background: transparent; color: var(--ai-blue); border-bottom: 2px solid var(--ai-blue); }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row align-items-center mb-5">
        <div class="col-md-7">
            <div class="ai-chat-bubble">
                <h5 class="fw-bold"><i class="bi bi-robot"></i> Gemini AI 財務分析師</h5>
                <p id="ai-insight" class="mb-0">正在掃描您的資產庫存... 請確保已輸入您的銀行存款與股票代號。</p>
            </div>
        </div>
        <div class="col-md-5 text-end text-md-start mt-3 mt-md-0">
            <h1 class="fw-bold mb-0">資產儀表板</h1>
            <p class="text-muted">數據更新時間：{{ "{:,.0f}".format(total_cash + total_stock_value) }} TWD</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card p-4 stat-card">
                <small class="text-muted">現金資產</small>
                <h3 class="fw-bold">${{ "{:,.0f}".format(total_cash) }}</h3>
                <canvas id="cashMiniChart" height="50"></canvas>
            </div>
            <div class="card p-4 stat-card" style="border-top-color: #28a745;">
                <small class="text-muted">股票市值</small>
                <h3 class="fw-bold text-success">${{ "{:,.0f}".format(total_stock_value) }}</h3>
                <canvas id="stockMiniChart" height="50"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-4 h-100">
                <h6 class="fw-bold mb-3">資產成長曲線 (模擬趨勢)</h6>
                <canvas id="mainChart"></canvas>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-4 h-100">
                <h6 class="fw-bold mb-3">分配比例</h6>
                <canvas id="donutChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-lg-4">
            <div class="card p-4">
                <ul class="nav nav-tabs mb-3" id="actionTab">
                    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#normal-mode">一般紀錄</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#transfer-mode">銀行轉帳</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="normal-mode">
                        <form action="/action" method="POST">
                            <input type="hidden" name="mode" value="normal">
                            <input type="hidden" name="id" id="edit-id">
                            <input type="text" name="bank_name" id="edit-name" class="form-control mb-2" placeholder="銀行名稱/項目">
                            <input type="number" step="any" name="amount" id="edit-amount" class="form-control mb-3" placeholder="金額 (支出請用負數)">
                            <button class="btn btn-ai w-100">儲存變動</button>
                        </form>
                    </div>
                    <div class="tab-pane fade" id="transfer-mode">
                        <form action="/action" method="POST">
                            <input type="hidden" name="mode" value="transfer">
                            <input type="text" name="from_bank" class="form-control mb-2" placeholder="從哪家銀行轉出">
                            <input type="text" name="to_bank" class="form-control mb-2" placeholder="轉入哪家銀行">
                            <input type="number" step="any" name="amount" class="form-control mb-3" placeholder="轉帳金額">
                            <button class="btn btn-ai w-100">執行轉帳</button>
                        </form>
                    </div>
                </div>
                <hr>
                <h6 class="fw-bold text-success mb-2">＋ 記錄股票持倉</h6>
                <form action="/add_trade" method="POST">
                    <input type="text" name="symbol" class="form-control mb-2" placeholder="代號 (如 2330.TW)">
                    <input type="number" step="any" name="shares" class="form-control mb-3" placeholder="股數">
                    <button class="btn btn-success w-100 fw-bold" style="border-radius:10px;">更新股票</button>
                </form>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card p-4">
                <h6 class="fw-bold mb-3">資產明細一覽表</h6>
                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle">
                        <thead><tr><th>名稱/代號</th><th>類型</th><th>現值</th><th>操作</th></tr></thead>
                        <tbody>
                            {% for c in cash_items %}
                            <tr>
                                <td>{{ c[1] }}</td>
                                <td><span class="badge bg-secondary">現金</span></td>
                                <td class="{{ 'text-danger fw-bold' if c[2] < 0 else '' }}">${{ "{:,.2f}".format(c[2]) }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" onclick="editItem('{{ c[0] }}','{{ c[1] }}','{{ c[2] }}')">編輯</button>
                                    <a href="/delete_cash/{{ c[0] }}" class="text-danger ms-2">刪除</a>
                                </td>
                            </tr>
                            {% endfor %}
                            {% for s in stocks %}
                            <tr>
                                <td>{{ s.symbol }}</td>
                                <td><span class="badge bg-success">股票</span></td>
                                <td class="text-success fw-bold">${{ "{:,.2f}".format(s.value) }}</td>
                                <td><small class="text-muted">現價: {{ s.price }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const tc = {{ total_cash }};
    const ts = {{ total_stock_value }};
    const total = tc + ts;

    // 1. Donut Chart
    new Chart(document.getElementById('donutChart'), {
        type: 'doughnut',
        data: { labels: ['現金', '股票'], datasets: [{ data: [tc, ts], backgroundColor: ['#3b82f6', '#10b981'], borderWidth: 0 }] },
        options: { plugins: { legend: { display: false } }, cutout: '70%' }
    });

    // 2. Main Growth Chart (Mock)
    new Chart(document.getElementById('mainChart'), {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Today'],
            datasets: [{ label: '總價值', data: [total*0.8, total*0.85, total*0.92, total], borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
    });

    // 3. AI Insight
    const insight = document.getElementById('ai-insight');
    if (total > 0) {
        let ratio = (ts / total) * 100;
        if (ratio > 60) insight.innerText = `分析完畢！您的股票配置佔 ${ratio.toFixed(1)}%，屬於積極型。建議保留至少 6 個月的生活預備金。`;
        else if (ratio < 10) insight.innerText = "目前資產多為現金。在低利時代，建議撥出 20% 資金配置在全球化 ETF 以對抗通膨。";
        else insight.innerText = "您的資產結構非常健康！建議繼續保持定期定額投入，目前風險等級：中性穩定。";
    }

    function editItem(id, name, amount) {
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-name').value = name;
        document.getElementById('edit-amount').value = amount;
        const trigger = document.querySelector('#actionTab a[href="#normal-mode"]');
        bootstrap.Tab.getInstance(trigger).show();
    }
</script>
</body>
</html>
